# Phase1 決定事項（暫定）

本ファイルは、実装を進めるうえでブレやすい「前提・決定事項」を記録する。
後で変更した場合は、ここに追記し「いつ・なぜ・何が変わったか」を残す。

## 1. ユーザー識別子の扱い（`userId` と OIDC `sub`）

### 決定（暫定）
- Phase1 では `userId = OIDC sub`（Authentik の `sub`）として扱う。

### 理由
- MVP では「ログイン済みユーザーの所有データ分離」が主目的であり、別IDを発行する運用コストを増やさないため。
- DB/セッション/gRPC metadata の値を 1つに揃えられ、実装が単純になるため。

### 影響範囲
- DB の `user_id` / `author_user_id` は **文字列** として保持する（UUID前提にしない）。
- gRPC metadata で `x-user-id` のようなキーに `sub` を載せてバックエンドへ伝播する。
- Remix の Cookie セッションには `userId(sub)` を保持する（トークン本体は保持しない）。

### 将来の変更余地
- 将来的に「アプリ内 userId（UUID）を発行して `auth_subject` と紐付ける」方式へ移行する可能性がある。
- その場合は DB マイグレーションと、認証後のユーザー作成/解決ロジック（Upsert）が必要になる。

## 2. DB マイグレーション運用（ツール/方針）

### 決定（暫定）
- Phase1 では「SQLファイルによるマイグレーション」を採用し、ツールは導入時に確定する。
  - `backend/db/migrations/` を単一の真実とし、適用順をファイル名（タイムスタンプ）で管理する。

### 理由
- まずはスキーマと制約の合意を優先し、ツール選定を後ろ倒しできるようにするため。
- 既存の `docs/structure.md` と整合し、`sqlc`（生SQLを単一の真実）方針とも衝突しないため。

### TODO（確定が必要）
- ローカル適用（例: `atlas` / `goose` / `sqitch` 等）の採用可否
- CI での自動適用・検証方法（マイグレーション差分の検知）
- 本番適用手順（Fly.io / Neon の運用に合わせる）

