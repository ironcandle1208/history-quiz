name: deploy-fly

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - "client/**"
      - "proto/**"
      - "infra/fly/**"
      - "scripts/apply_db_migrations.sh"
      - "scripts/deploy_production_fly.sh"
      - "scripts/production_preflight.sh"
      - "scripts/production_smoke_check.sh"
      - "scripts/production_sync_fly_secrets.sh"
      - "scripts/verify_migration_files.sh"
      - "Makefile"
      - ".dockerignore"
      - ".github/workflows/deploy-fly.yml"
      # paths と paths-ignore は同時定義できないため、除外は否定パターンで表現する。
      - "!backend/**/*_test.go"
      - "!client/tests/**"
      - "!.walkthrough/**"
  workflow_dispatch:
    inputs:
      target_environment:
        description: "デプロイ先環境"
        required: true
        default: staging
        type: choice
        options:
          - staging
          - production
      run_migrations:
        description: "デプロイ前に migration を実行する"
        required: true
        default: true
        type: boolean
      run_smoke_check:
        description: "デプロイ後にスモークチェックを実行する"
        required: true
        default: true
        type: boolean
      run_origin_direct_check:
        description: "障害切り分け用に Fly Origin 直疎通チェックを実行する"
        required: true
        default: false
        type: boolean
      deploy_authentik:
        description: "Authentik を同時デプロイする（production 手動時のみ有効）"
        required: true
        default: false
        type: boolean

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  resolve-staging-deploy-flags:
    # push / 手動の両方で staging 用フラグを 1 箇所で決定する。
    runs-on: ubuntu-latest
    outputs:
      run_migrations: ${{ steps.resolve.outputs.run_migrations }}
      run_smoke_check: ${{ steps.resolve.outputs.run_smoke_check }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve deploy flags
        id: resolve
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "run_migrations=${{ inputs.run_migrations }}" >> "$GITHUB_OUTPUT"
            echo "run_smoke_check=${{ inputs.run_smoke_check }}" >> "$GITHUB_OUTPUT"
            echo "INFO: 手動実行入力をそのまま採用しました。"
            exit 0
          fi

          base_sha="${{ github.event.before }}"
          if [ -z "$base_sha" ] || [ "$base_sha" = "0000000000000000000000000000000000000000" ]; then
            changed_files="$(git ls-files)"
          else
            changed_files="$(git diff --name-only "$base_sha" "${{ github.sha }}")"
          fi

          run_migrations=false
          run_smoke_check=false

          while IFS= read -r file_path; do
            [ -z "$file_path" ] && continue
            case "$file_path" in
              backend/db/migrations/*|scripts/apply_db_migrations.sh|scripts/verify_migration_files.sh)
                run_migrations=true
                ;;
            esac
            case "$file_path" in
              backend/*|client/*|proto/*|infra/fly/*|scripts/deploy_production_fly.sh|scripts/production_smoke_check.sh|scripts/production_preflight.sh|scripts/production_sync_fly_secrets.sh|Makefile|.dockerignore)
                run_smoke_check=true
                ;;
            esac
          done <<EOF_CHANGED_FILES
          $changed_files
          EOF_CHANGED_FILES

          echo "run_migrations=$run_migrations" >> "$GITHUB_OUTPUT"
          echo "run_smoke_check=$run_smoke_check" >> "$GITHUB_OUTPUT"
          echo "INFO: push 判定 run_migrations=$run_migrations run_smoke_check=$run_smoke_check"

  deploy-staging:
    # main push は staging へ自動デプロイ。
    # 手動実行でも target_environment=staging を選べるようにする。
    needs: resolve-staging-deploy-flags
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.target_environment == 'staging')
    runs-on: ubuntu-latest
    environment: staging
    concurrency:
      # staging への同時デプロイを防止する。
      group: deploy-fly-staging
      cancel-in-progress: false
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      # Fly.io アプリ設定（Environment variables を想定）
      FLY_CLIENT_APP: ${{ vars.FLY_CLIENT_APP }}
      FLY_BACKEND_APP: ${{ vars.FLY_BACKEND_APP }}
      FLY_CLIENT_CONFIG: ${{ vars.FLY_CLIENT_CONFIG || 'infra/fly/client.fly.toml' }}
      FLY_BACKEND_CONFIG: ${{ vars.FLY_BACKEND_CONFIG || 'infra/fly/backend.fly.toml' }}
      FLY_AUTHENTIK_APP: ${{ vars.FLY_AUTHENTIK_APP }}
      FLY_AUTHENTIK_CONFIG: ${{ vars.FLY_AUTHENTIK_CONFIG }}
      # staging は追加固定費を防ぐため Authentik 同時デプロイを無効固定にする。
      DEPLOY_AUTHENTIK: "false"

      # Secrets（Environment secrets を想定）
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
      OIDC_CLIENT_SECRET: ${{ secrets.OIDC_CLIENT_SECRET }}
      AUTHENTIK_SECRET_KEY: ${{ secrets.AUTHENTIK_SECRET_KEY }}
      AUTHENTIK_POSTGRES_PASSWORD: ${{ secrets.AUTHENTIK_POSTGRES_PASSWORD }}
      AUTHENTIK_BOOTSTRAP_PASSWORD: ${{ secrets.AUTHENTIK_BOOTSTRAP_PASSWORD }}

      # 非秘密設定（Environment variables を想定）
      OIDC_ISSUER_URL: ${{ vars.OIDC_ISSUER_URL }}
      OIDC_CLIENT_ID: ${{ vars.OIDC_CLIENT_ID }}
      OIDC_REDIRECT_URI: ${{ vars.OIDC_REDIRECT_URI }}
      BACKEND_GRPC_ADDRESS: ${{ vars.BACKEND_GRPC_ADDRESS }}
      OIDC_SCOPES: ${{ vars.OIDC_SCOPES }}
      BACKEND_GRPC_TIMEOUT_MS: ${{ vars.BACKEND_GRPC_TIMEOUT_MS }}
      BACKEND_GRPC_TLS: ${{ vars.BACKEND_GRPC_TLS }}
      GRPC_PROTO_ROOT: ${{ vars.GRPC_PROTO_ROOT }}
      DEPLOY_CLIENT_BASE_URL: ${{ vars.DEPLOY_CLIENT_BASE_URL }}
      DEPLOY_CLIENT_ORIGIN_BASE_URL: ${{ vars.DEPLOY_CLIENT_ORIGIN_BASE_URL }}
      AUTHENTIK_POSTGRES_USER: ${{ vars.AUTHENTIK_POSTGRES_USER }}
      AUTHENTIK_POSTGRES_DB: ${{ vars.AUTHENTIK_POSTGRES_DB }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Install psql client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Prepare infra/fly/apps.env
        run: |
          # スクリプト群が参照する apps.env を CI 上で組み立てる。
          cat > infra/fly/apps.env <<EOF_APPS
          FLY_CLIENT_APP=${FLY_CLIENT_APP}
          FLY_BACKEND_APP=${FLY_BACKEND_APP}
          FLY_CLIENT_CONFIG=${FLY_CLIENT_CONFIG}
          FLY_BACKEND_CONFIG=${FLY_BACKEND_CONFIG}
          BACKEND_GRPC_ADDRESS=${BACKEND_GRPC_ADDRESS}
          EOF_APPS

          if [ -n "${FLY_AUTHENTIK_APP:-}" ]; then
            echo "FLY_AUTHENTIK_APP=${FLY_AUTHENTIK_APP}" >> infra/fly/apps.env
          fi
          if [ -n "${FLY_AUTHENTIK_CONFIG:-}" ]; then
            echo "FLY_AUTHENTIK_CONFIG=${FLY_AUTHENTIK_CONFIG}" >> infra/fly/apps.env
          fi

      - name: Preflight
        run: make production-preflight

      - name: Sync Fly secrets
        run: make production-sync-secrets

      - name: Deploy to staging
        env:
          RUN_MIGRATIONS: ${{ needs.resolve-staging-deploy-flags.outputs.run_migrations }}
          RUN_SMOKE_CHECK: ${{ needs.resolve-staging-deploy-flags.outputs.run_smoke_check }}
        run: make production-deploy

  deploy-production:
    # production は手動実行のみ許可し、Environment 側の承認フローを前提にする。
    if: github.event_name == 'workflow_dispatch' && inputs.target_environment == 'production'
    runs-on: ubuntu-latest
    environment: production
    concurrency:
      # production への同時デプロイを防止する。
      group: deploy-fly-production
      cancel-in-progress: false
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      # Fly.io アプリ設定（Environment variables を想定）
      FLY_CLIENT_APP: ${{ vars.FLY_CLIENT_APP }}
      FLY_BACKEND_APP: ${{ vars.FLY_BACKEND_APP }}
      FLY_CLIENT_CONFIG: ${{ vars.FLY_CLIENT_CONFIG || 'infra/fly/client.production.fly.toml' }}
      FLY_BACKEND_CONFIG: ${{ vars.FLY_BACKEND_CONFIG || 'infra/fly/backend.production.fly.toml' }}
      FLY_AUTHENTIK_APP: ${{ vars.FLY_AUTHENTIK_APP }}
      FLY_AUTHENTIK_CONFIG: ${{ vars.FLY_AUTHENTIK_CONFIG }}
      DEPLOY_AUTHENTIK: ${{ inputs.deploy_authentik }}

      # Secrets（Environment secrets を想定）
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
      OIDC_CLIENT_SECRET: ${{ secrets.OIDC_CLIENT_SECRET }}
      AUTHENTIK_SECRET_KEY: ${{ secrets.AUTHENTIK_SECRET_KEY }}
      AUTHENTIK_POSTGRES_PASSWORD: ${{ secrets.AUTHENTIK_POSTGRES_PASSWORD }}
      AUTHENTIK_BOOTSTRAP_PASSWORD: ${{ secrets.AUTHENTIK_BOOTSTRAP_PASSWORD }}

      # 非秘密設定（Environment variables を想定）
      OIDC_ISSUER_URL: ${{ vars.OIDC_ISSUER_URL }}
      OIDC_CLIENT_ID: ${{ vars.OIDC_CLIENT_ID }}
      OIDC_REDIRECT_URI: ${{ vars.OIDC_REDIRECT_URI }}
      BACKEND_GRPC_ADDRESS: ${{ vars.BACKEND_GRPC_ADDRESS }}
      OIDC_SCOPES: ${{ vars.OIDC_SCOPES }}
      BACKEND_GRPC_TIMEOUT_MS: ${{ vars.BACKEND_GRPC_TIMEOUT_MS }}
      BACKEND_GRPC_TLS: ${{ vars.BACKEND_GRPC_TLS }}
      GRPC_PROTO_ROOT: ${{ vars.GRPC_PROTO_ROOT }}
      DEPLOY_CLIENT_BASE_URL: ${{ vars.DEPLOY_CLIENT_BASE_URL }}
      DEPLOY_CLIENT_ORIGIN_BASE_URL: ${{ vars.DEPLOY_CLIENT_ORIGIN_BASE_URL }}
      AUTHENTIK_POSTGRES_USER: ${{ vars.AUTHENTIK_POSTGRES_USER }}
      AUTHENTIK_POSTGRES_DB: ${{ vars.AUTHENTIK_POSTGRES_DB }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Install psql client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Prepare infra/fly/apps.env
        run: |
          # スクリプト群が参照する apps.env を CI 上で組み立てる。
          cat > infra/fly/apps.env <<EOF_APPS
          FLY_CLIENT_APP=${FLY_CLIENT_APP}
          FLY_BACKEND_APP=${FLY_BACKEND_APP}
          FLY_CLIENT_CONFIG=${FLY_CLIENT_CONFIG}
          FLY_BACKEND_CONFIG=${FLY_BACKEND_CONFIG}
          BACKEND_GRPC_ADDRESS=${BACKEND_GRPC_ADDRESS}
          EOF_APPS

          if [ -n "${FLY_AUTHENTIK_APP:-}" ]; then
            echo "FLY_AUTHENTIK_APP=${FLY_AUTHENTIK_APP}" >> infra/fly/apps.env
          fi
          if [ -n "${FLY_AUTHENTIK_CONFIG:-}" ]; then
            echo "FLY_AUTHENTIK_CONFIG=${FLY_AUTHENTIK_CONFIG}" >> infra/fly/apps.env
          fi

      - name: Preflight
        run: make production-preflight

      - name: Sync Fly secrets
        run: make production-sync-secrets

      - name: Deploy to production
        env:
          RUN_MIGRATIONS: ${{ inputs.run_migrations }}
          RUN_SMOKE_CHECK: ${{ inputs.run_smoke_check }}
        run: make production-deploy

  origin-direct-smoke-staging:
    # Cloudflare 障害時の切り分け用途として、手動実行時のみ Origin 直疎通を許可する。
    if: github.event_name == 'workflow_dispatch' && inputs.target_environment == 'staging' && inputs.run_origin_direct_check
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: staging
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      FLY_CLIENT_APP: ${{ vars.FLY_CLIENT_APP }}
      FLY_BACKEND_APP: ${{ vars.FLY_BACKEND_APP }}
      DEPLOY_CLIENT_ORIGIN_BASE_URL: ${{ vars.DEPLOY_CLIENT_ORIGIN_BASE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Validate origin direct URL
        run: |
          if [ -z "${DEPLOY_CLIENT_ORIGIN_BASE_URL:-}" ]; then
            echo "エラー: DEPLOY_CLIENT_ORIGIN_BASE_URL が未設定です。"
            echo "       staging 環境変数に Fly Origin URL を設定してください。"
            exit 1
          fi

      - name: Prepare infra/fly/apps.env
        run: |
          cat > infra/fly/apps.env <<EOF_APPS
          FLY_CLIENT_APP=${FLY_CLIENT_APP}
          FLY_BACKEND_APP=${FLY_BACKEND_APP}
          EOF_APPS

      - name: Origin direct smoke (staging)
        env:
          SMOKE_CHECK_MODE: origin
          DEPLOY_CLIENT_BASE_URL: ${{ vars.DEPLOY_CLIENT_ORIGIN_BASE_URL }}
        run: make production-smoke

  origin-direct-smoke-production:
    # Cloudflare 障害時の切り分け用途として、手動実行時のみ Origin 直疎通を許可する。
    if: github.event_name == 'workflow_dispatch' && inputs.target_environment == 'production' && inputs.run_origin_direct_check
    needs: deploy-production
    runs-on: ubuntu-latest
    environment: production
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      FLY_CLIENT_APP: ${{ vars.FLY_CLIENT_APP }}
      FLY_BACKEND_APP: ${{ vars.FLY_BACKEND_APP }}
      DEPLOY_CLIENT_ORIGIN_BASE_URL: ${{ vars.DEPLOY_CLIENT_ORIGIN_BASE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Validate origin direct URL
        run: |
          if [ -z "${DEPLOY_CLIENT_ORIGIN_BASE_URL:-}" ]; then
            echo "エラー: DEPLOY_CLIENT_ORIGIN_BASE_URL が未設定です。"
            echo "       production 環境変数に Fly Origin URL を設定してください。"
            exit 1
          fi

      - name: Prepare infra/fly/apps.env
        run: |
          cat > infra/fly/apps.env <<EOF_APPS
          FLY_CLIENT_APP=${FLY_CLIENT_APP}
          FLY_BACKEND_APP=${FLY_BACKEND_APP}
          EOF_APPS

      - name: Origin direct smoke (production)
        env:
          SMOKE_CHECK_MODE: origin
          DEPLOY_CLIENT_BASE_URL: ${{ vars.DEPLOY_CLIENT_ORIGIN_BASE_URL }}
        run: make production-smoke
